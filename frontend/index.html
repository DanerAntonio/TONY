<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de PetShop</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4e54c8;
            --secondary-color: #8f94fb;
            --accent-color: #ff9a8b;
            --text-color: #333;
            --background-color: #f4f7f6;
        }
        body {
            background-color: var(--background-color);
            color: var(--text-color);
        }
        .navbar {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
        }
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        .btn-primary:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        .card {
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .table {
            background-color: white;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="#">🐾 Gestor de PetShop</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="mostrarSeccion('productos')">Productos</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="mostrarSeccion('compras')">Compras</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="mostrarSeccion('proveedores')">Proveedores</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="mostrarSeccion('clientes')">Clientes</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <div id="productos" class="section">
            <h2 class="mb-4">Gestión de Productos</h2>
            <button class="btn btn-primary mb-3" onclick="mostrarModal('producto')">Nuevo Producto</button>
            <div class="card">
                <div class="card-body">
                    <div class="mb-3">
                        <input type="text" class="form-control" id="buscarProducto" placeholder="Buscar producto...">
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped" id="tablaProductos">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Precio</th>
                                    <th>Stock</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <nav aria-label="Paginación de productos">
                        <ul class="pagination justify-content-center" id="paginacionProductos"></ul>
                    </nav>
                </div>
            </div>
        </div>

        <div id="compras" class="section" style="display: none;">
            <h2 class="mb-4">Gestión de Compras</h2>
            <button class="btn btn-primary mb-3" onclick="mostrarModal('compra')">Nueva Compra</button>
            <div class="card">
                <div class="card-body">
                    <div class="mb-3">
                        <input type="text" class="form-control" id="buscarCompra" placeholder="Buscar compra...">
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped" id="tablaCompras">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Fecha</th>
                                    <th>Proveedor</th>
                                    <th>Total</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <nav aria-label="Paginación de compras">
                        <ul class="pagination justify-content-center" id="paginacionCompras"></ul>
                    </nav>
                </div>
            </div>
        </div>

        <div id="proveedores" class="section" style="display: none;">
            <h2 class="mb-4">Gestión de Proveedores</h2>
            <button class="btn btn-primary mb-3" onclick="mostrarModal('proveedor')">Nuevo Proveedor</button>
            <div class="card">
                <div class="card-body">
                    <div class="mb-3">
                        <input type="text" class="form-control" id="buscarProveedor" placeholder="Buscar proveedor...">
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped" id="tablaProveedores">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Email</th>
                                    <th>Teléfono</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <nav aria-label="Paginación de proveedores">
                        <ul class="pagination justify-content-center" id="paginacionProveedores"></ul>
                    </nav>
                </div>
            </div>
        </div>

        <div id="clientes" class="section" style="display: none;">
            <h2 class="mb-4">Gestión de Clientes</h2>
            <button class="btn btn-primary mb-3" onclick="mostrarModal('cliente')">Nuevo Cliente</button>
            <div class="card">
                <div class="card-body">
                    <div class="mb-3">
                        <input type="text" class="form-control" id="buscarCliente" placeholder="Buscar cliente...">
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped" id="tablaClientes">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Email</th>
                                    <th>Teléfono</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <nav aria-label="Paginación de clientes">
                        <ul class="pagination justify-content-center" id="paginacionClientes"></ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- Modales -->
    <div class="modal fade" id="modalProducto" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Producto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formProducto">
                        <input type="hidden" id="productoId">
                        <div class="mb-3">
                            <label for="nombreProducto" class="form-label">Nombre</label>
                            <input type="text" class="form-control" id="nombreProducto" required>
                        </div>
                        <div class="mb-3">
                            <label for="precioProducto" class="form-label">Precio</label>
                            <input type="number" class="form-control" id="precioProducto" required>
                        </div>
                        <div class="mb-3">
                            <label for="stockProducto" class="form-label">Stock</label>
                            <input type="number" class="form-control" id="stockProducto" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="guardarProducto()">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalCompra" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nueva Compra</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formCompra">
                        <div class="mb-3">
                            <label for="proveedorCompra" class="form-label">Proveedor</label>
                            <select class="form-select" id="proveedorCompra" required></select>
                        </div>
                        <div id="productosCompra">
                            <!-- Aquí se agregarán dinámicamente los productos de la compra -->
                        </div>
                        <button type="button" class="btn btn-secondary mt-2" onclick="agregarProductoCompra()">Agregar Producto</button>
                        <div class="mt-3">
                            <strong>Subtotal: $<span id="subtotalCompra">0.00</span></strong><br>
                            <strong>IVA (12%): $<span id="ivaCompra">0.00</span></strong><br>
                            <strong>Total: $<span id="totalCompra">0.00</span></strong>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="guardarCompra()">Guardar Compra</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalProveedor" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Proveedor</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formProveedor">
                        <input type="hidden" id="proveedorId">
                        <div class="mb-3">
                            <label for="nombreProveedor" class="form-label">Nombre</label>
                            <input type="text" class="form-control" id="nombreProveedor" required>
                        </div>
                        <div class="mb-3">
                            <label for="emailProveedor" class="form-label">Email</label>
                            <input type="email" class="form-control" id="emailProveedor" required>
                        </div>
                        <div class="mb-3">
                            <label for="telefonoProveedor" class="form-label">Teléfono</label>
                            <input type="tel" class="form-control" id="telefonoProveedor" required>
                        </div>
                        <div class="mb-3">
                            <label for="direccionProveedor" class="form-label">Dirección</label>
                            <input type="text" class="form-control" id="direccionProveedor" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="guardarProveedor()">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalCliente" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Cliente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formCliente">
                        <input type="hidden" id="clienteId">
                        <div class="mb-3">
                            <label for="nombreCliente" class="form-label">Nombre</label>
                            <input type="text" class="form-control" id="nombreCliente" required>
                        </div>
                        <div class="mb-3">
                            <label for="cedulaCliente" class="form-label">Cédula</label>
                            <input type="text" class="form-control" id="cedulaCliente" required>
                        </div>
                        <div class="mb-3">
                            <label for="emailCliente" class="form-label">Email</label>
                            <input type="email" class="form-control" id="emailCliente" required>
                        </div>
                        <div class="mb-3">
                            <label for="telefonoCliente" class="form-label">Teléfono</label>
                            <input type="tel" class="form-control" id="telefonoCliente" required>
                        </div>
                        <div class="mb-3">
                            <label for="direccionCliente" class="form-label">Dirección</label>
                            <input type="text" class="form-control" id="direccionCliente" required>
                        </div>
                    </form>
                
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="guardarCliente()">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.all.min.js"></script>
    <script>
   const API_URL = 'https://tony-m6cg.onrender.com/api';
        let seccionActual = 'productos';
        const elementosPorPagina = 10;
        let paginaActual = 1;
        let productosCompra = [];
        const IVA = 0.12; // 12% de IVA

        // Funciones de utilidad
        function mostrarSeccion(seccion) {
            document.querySelectorAll('.section').forEach(el => el.style.display = 'none');
            document.getElementById(seccion).style.display = 'block';
            seccionActual = seccion;
            paginaActual = 1;
            cargarDatos();
        }

        function mostrarModal(tipo) {
            const modal = new bootstrap.Modal(document.getElementById(`modal${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`));
            modal.show();
        }

        async function obtenerDatos(endpoint) {
            try {
                const respuesta = await fetch(`${API_URL}/${endpoint}`);
                if (!respuesta.ok) {
                    const textoError = await respuesta.text();
                    throw new Error(`Error HTTP! estado: ${respuesta.status}, mensaje: ${textoError}`);
                }
                return await respuesta.json();
            } catch (error) {
                console.error('Error al obtener datos:', error);
                Swal.fire('Error', `Hubo un problema al cargar los datos: ${error.message}`, 'error');
                return null;
            }
        }

        async function enviarDatos(endpoint, datos) {
            try {
                const respuesta = await fetch(`${API_URL}/${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datos)
                });
                if (!respuesta.ok) {
                    const textoError = await respuesta.text();
                    throw new Error(`Error HTTP! estado: ${respuesta.status}, mensaje: ${textoError}`);
                }
                return await respuesta.json();
            } catch (error) {
                console.error('Error al enviar datos:', error);
                Swal.fire('Error', `Hubo un problema al guardar los datos: ${error.message}`, 'error');
                return null;
            }
        }

        async function actualizarDatos(endpoint, id, datos) {
            try {
                const respuesta = await fetch(`${API_URL}/${endpoint}/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datos)
                });
                if (!respuesta.ok) {
                    const textoError = await respuesta.text();
                    throw new Error(`Error HTTP! estado: ${respuesta.status}, mensaje: ${textoError}`);
                }
                return await respuesta.json();
            } catch (error) {
                console.error('Error al actualizar datos:', error);
                Swal.fire('Error', `Hubo un problema al actualizar los datos: ${error.message}`, 'error');
                return null;
            }
        }

        async function eliminarDatos(endpoint, id) {
            try {
                const respuesta = await fetch(`${API_URL}/${endpoint}/${id}`, { method: 'DELETE' });
                if (!respuesta.ok) {
                    const textoError = await respuesta.text();
                    throw new Error(`Error HTTP! estado: ${respuesta.status}, mensaje: ${textoError}`);
                }
                return await respuesta.json();
            } catch (error) {
                console.error('Error al eliminar datos:', error);
                Swal.fire('Error', `Hubo un problema al eliminar los datos: ${error.message}`, 'error');
                return null;
            }
        }

        function crearPaginacion(totalElementos, contenedorId) {
            const totalPaginas = Math.ceil(totalElementos / elementosPorPagina);
            const contenedor = document.getElementById(contenedorId);
            contenedor.innerHTML = '';

            for (let i = 1; i <= totalPaginas; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === paginaActual ? 'active' : ''}`;
                const a = document.createElement('a');
                a.className = 'page-link';
                a.href = '#';
                a.textContent = i;
                a.onclick = (e) => {
                    e.preventDefault();
                    paginaActual = i;
                    cargarDatos();
                };
                li.appendChild(a);
                contenedor.appendChild(li);
            }
        }

        // Funciones específicas para cada sección
        async function cargarProductos() {
            const productos = await obtenerDatos('productos');
            if (!productos) return;
            const tabla = document.getElementById('tablaProductos').getElementsByTagName('tbody')[0];
            tabla.innerHTML = '';
            productos.slice((paginaActual - 1) * elementosPorPagina, paginaActual * elementosPorPagina).forEach(producto => {
                const fila = tabla.insertRow();
                fila.innerHTML = `
                    <td>${producto.nombre}</td>
                    <td>$${producto.precio.toFixed(2)}</td>
                    <td>${producto.stock}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editarProducto('${producto._id}')">Editar</button>
                        <button class="btn btn-sm btn-danger" onclick="eliminarProducto('${producto._id}')">Eliminar</button>
                    </td>
                `;
            });
            crearPaginacion(productos.length, 'paginacionProductos');
        }

        async function cargarCompras() {
            try {
                console.log('Iniciando carga de compras');
                const compras = await obtenerDatos('compras');
                console.log('Compras obtenidas:', compras);
                if (!compras || !Array.isArray(compras)) {
                    console.error('No se obtuvieron compras o el formato es incorrecto');
                    Swal.fire('Error', 'No se pudieron cargar las compras', 'error');
                    return;
                }
                const tabla = document.getElementById('tablaCompras').getElementsByTagName('tbody')[0];
                tabla.innerHTML = '';
                compras.forEach(compra => {
                    const fila = tabla.insertRow();
                    fila.innerHTML = `
                        <td>${compra._id}</td>
                        <td>${new Date(compra.fecha).toLocaleString()}</td>
                        <td>${compra.proveedor ? compra.proveedor.nombre : 'N/A'}</td>
                        <td>$${compra.total.toFixed(2)}</td>
                        <td>${compra.estado}</td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="verDetalleCompra('${compra._id}')">Ver Detalle</button>
                            <button class="btn btn-sm btn-warning" onclick="anularCompra('${compra._id}')" ${compra.estado === 'Anulada' ? 'disabled' : ''}>Anular</button>
                        </td>
                    `;
                });
                console.log('Carga de compras completada');
                crearPaginacion(compras.length, 'paginacionCompras');
            } catch (error) {
                console.error('Error al cargar compras:', error);
                Swal.fire('Error', `No se pudieron cargar las compras: ${error.message}`, 'error');
            }
        }

        async function cargarProveedores() {
            const proveedores = await obtenerDatos('proveedores');
            if (!proveedores) return;
            const tabla = document.getElementById('tablaProveedores').getElementsByTagName('tbody')[0];
            tabla.innerHTML = '';
            proveedores.slice((paginaActual - 1) * elementosPorPagina, paginaActual * elementosPorPagina).forEach(proveedor => {
                const fila = tabla.insertRow();
                fila.innerHTML = `
                    <td>${proveedor.nombre}</td>
                    <td>${proveedor.email}</td>
                    <td>${proveedor.telefono}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editarProveedor('${proveedor._id}')">Editar</button>
                        <button class="btn btn-sm btn-danger" onclick="eliminarProveedor('${proveedor._id}')">Eliminar</button>
                    </td>
                `;
            });
            crearPaginacion(proveedores.length, 'paginacionProveedores');
        }

        async function cargarClientes() {
            const clientes = await obtenerDatos('clientes');
            if (!clientes) return;
            const tabla = document.getElementById('tablaClientes').getElementsByTagName('tbody')[0];
            tabla.innerHTML = '';
            clientes.slice((paginaActual - 1) * elementosPorPagina, paginaActual * elementosPorPagina).forEach(cliente => {
                const fila = tabla.insertRow();
                fila.innerHTML = `
                    <td>${cliente.nombreCliente}</td>
                    <td>${cliente.email}</td>
                    <td>${cliente.telefono}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editarCliente('${cliente._id}')">Editar</button>
                        <button class="btn btn-sm btn-danger" onclick="eliminarCliente('${cliente._id}')">Eliminar</button>
                    </td>
                `;
            });
            crearPaginacion(clientes.length, 'paginacionClientes');
        }

        function cargarDatos() {
            switch (seccionActual) {
                case 'productos':
                    cargarProductos();
                    break;
                case 'compras':
                    cargarCompras();
                    break;
                case 'proveedores':
                    cargarProveedores();
                    break;
                case 'clientes':
                    cargarClientes();
                    break;
            }
        }

        // Funciones para manejar productos
        async function guardarProducto() {
            const producto = {
                nombre: document.getElementById('nombreProducto').value,
                precio: parseFloat(document.getElementById('precioProducto').value),
                stock: parseInt(document.getElementById('stockProducto').value)
            };
            const id = document.getElementById('productoId').value;
            let resultado;
            if (id) {
                resultado = await actualizarDatos('productos', id, producto);
            } else {
                resultado = await enviarDatos('productos', producto);
            }
            if (resultado) {
                Swal.fire('Éxito', 'Producto guardado correctamente', 'success');
                bootstrap.Modal.getInstance(document.getElementById('modalProducto')).hide();
                cargarProductos();
            }
        }

        async function editarProducto(id) {
            const producto = await obtenerDatos(`productos/${id}`);
            if (!producto) return;
            document.getElementById('productoId').value = producto._id;
            document.getElementById('nombreProducto').value = producto.nombre;
            document.getElementById('precioProducto').value = producto.precio;
            document.getElementById('stockProducto').value = producto.stock;
            mostrarModal('producto');
        }

        async function eliminarProducto(id) {
            const resultado = await Swal.fire({
                title: '¿Estás seguro?',
                text: "No podrás revertir esta acción",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, eliminar'
            });
            if (resultado.isConfirmed) {
                const respuesta = await eliminarDatos('productos', id);
                if (respuesta) {
                    Swal.fire('Eliminado', 'El producto ha sido eliminado', 'success');
                    cargarProductos();
                }
            }
        }

        // Funciones para manejar compras
        async function cargarProveedoresSelect() {
            const proveedores = await obtenerDatos('proveedores');
            if (!proveedores) return;
            const select = document.getElementById('proveedorCompra');
            select.innerHTML = '<option value="">Seleccione un proveedor</option>';
            proveedores.forEach(proveedor => {
                select.innerHTML += `<option value="${proveedor._id}">${proveedor.nombre}</option>`;
            });
        }

        async function agregarProductoCompra() {
            const productos = await obtenerDatos('productos');
            if (!productos) return;
            const { value: formValues } = await Swal.fire({
                title: 'Agregar Producto a la Compra',
                html:
                    '<select id="swal-producto" class="swal2-select">' +
                    '<option value="">Seleccione un producto</option>' +
                    productos.map(p => `<option value="${p._id}">${p.nombre}</option>`).join('') +
                    '</select>' +
                    '<input id="swal-cantidad" class="swal2-input" placeholder="Cantidad" type="number">' +
                    '<input id="swal-precio" class="swal2-input" placeholder="Precio Unitario" type="number" step="0.01">',
                focusConfirm: false,
                preConfirm: () => {
                    return {
                        producto: document.getElementById('swal-producto').value,
                        cantidad: document.getElementById('swal-cantidad').value,
                        precio: document.getElementById('swal-precio').value
                    }
                }
            });

            if (formValues) {
                const producto = productos.find(p => p._id === formValues.producto);
                if (producto) {
                    productosCompra.push({
                        producto: producto._id,
                        nombre: producto.nombre,
                        cantidad: parseInt(formValues.cantidad),
                        precioUnitario: parseFloat(formValues.precio)
                    });
                    actualizarTablaProductosCompra();
                    calcularTotalesCompra();
                }
            }
        }
        
        function actualizarTablaProductosCompra() {
            const contenedor = document.getElementById('productosCompra');
            contenedor.innerHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Cantidad</th>
                            <th>Precio Unitario</th>
                            <th>Subtotal</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${productosCompra.map((p, index) => `
                            <tr>
                                <td>${p.nombre}</td>
                                <td>${p.cantidad}</td>
                                <td>$${p.precioUnitario.toFixed(2)}</td>
                                <td>$${(p.cantidad * p.precioUnitario).toFixed(2)}</td>
                                <td>
                                    <button class="btn btn-sm btn-danger" onclick="eliminarProductoCompra(${index})">Eliminar</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function eliminarProductoCompra(index) {
            productosCompra.splice(index, 1);
            actualizarTablaProductosCompra();
            calcularTotalesCompra();
        }

        function calcularTotalesCompra() {
            const subtotal = productosCompra.reduce((total, p) => total + p.cantidad * p.precioUnitario, 0);
            const iva = subtotal * IVA;
            const total = subtotal + iva;

            document.getElementById('subtotalCompra').textContent = subtotal.toFixed(2);
            document.getElementById('ivaCompra').textContent = iva.toFixed(2);
            document.getElementById('totalCompra').textContent = total.toFixed(2);
        }

        async function guardarCompra() {
            const proveedor = document.getElementById('proveedorCompra').value;
            if (!proveedor) {
                Swal.fire('Error', 'Debe seleccionar un proveedor', 'error');
                return;
            }
            if (productosCompra.length === 0) {
                Swal.fire('Error', 'Debe agregar al menos un producto a la compra', 'error');
                return;
            }

            const subtotal = parseFloat(document.getElementById('subtotalCompra').textContent);
            const iva = parseFloat(document.getElementById('ivaCompra').textContent);
            const total = parseFloat(document.getElementById('totalCompra').textContent);

            const compra = {
                proveedor,
                productos: productosCompra,
                subtotal,
                iva,
                total
            };

            const resultado = await enviarDatos('compras', compra);
            if (resultado) {
                Swal.fire('Éxito', 'Compra guardada correctamente', 'success');
                bootstrap.Modal.getInstance(document.getElementById('modalCompra')).hide();
                productosCompra = [];
                cargarCompras();
            }
        }

        async function verDetalleCompra(id) {
            const compra = await obtenerDatos(`compras/${id}`);
            if (!compra) return;

            let detalleHTML = `
                <h3>Detalle de Compra</h3>
                <p><strong>ID:</strong> ${compra._id}</p>
                <p><strong>Fecha:</strong> ${new Date(compra.fecha).toLocaleString()}</p>
                <p><strong>Proveedor:</strong> ${compra.proveedor ? compra.proveedor.nombre : 'N/A'}</p>
                <p><strong>Estado:</strong> ${compra.estado}</p>
                <h4>Productos:</h4>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Cantidad</th>
                            <th>Precio Unitario</th>
                            <th>Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${compra.productos.map(p => `
                            <tr>
                                <td>${p.producto ? p.producto.nombre : 'N/A'}</td>
                                <td>${p.cantidad}</td>
                                <td>$${p.precioUnitario.toFixed(2)}</td>
                                <td>$${(p.cantidad * p.precioUnitario).toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                <p><strong>Subtotal:</strong> $${compra.subtotal.toFixed(2)}</p>
                <p><strong>IVA:</strong> $${compra.iva.toFixed(2)}</p>
                <p><strong>Total:</strong> $${compra.total.toFixed(2)}</p>
            `;

            Swal.fire({
                title: 'Detalle de Compra',
                html: detalleHTML,
                width: '80%',
                confirmButtonText: 'Cerrar'
            });
        }

        async function anularCompra(id) {
            const resultado = await Swal.fire({
                title: '¿Estás seguro?',
                text: "Esta acción anulará la compra",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, anular'
            });
            if (resultado.isConfirmed) {
                const respuesta = await actualizarDatos('compras', id, { estado: 'Anulada' });
                if (respuesta) {
                    Swal.fire('Anulada', 'La compra ha sido anulada', 'success');
                    cargarCompras();
                }
            }
        }

        // Funciones para manejar proveedores
        async function guardarProveedor() {
            const proveedor = {
                nombre: document.getElementById('nombreProveedor').value,
                email: document.getElementById('emailProveedor').value,
                telefono: document.getElementById('telefonoProveedor').value,
                direccion: document.getElementById('direccionProveedor').value
            };
            const id = document.getElementById('proveedorId').value;
            let resultado;
            if (id) {
                resultado = await actualizarDatos('proveedores', id, proveedor);
            } else {
                resultado = await enviarDatos('proveedores', proveedor);
            }
            if (resultado) {
                Swal.fire('Éxito', 'Proveedor guardado correctamente', 'success');
                bootstrap.Modal.getInstance(document.getElementById('modalProveedor')).hide();
                cargarProveedores();
            }
        }

        async function editarProveedor(id) {
            const proveedor = await obtenerDatos(`proveedores/${id}`);
            if (!proveedor) return;
            document.getElementById('proveedorId').value = proveedor._id;
            document.getElementById('nombreProveedor').value = proveedor.nombre;
            document.getElementById('emailProveedor').value = proveedor.email;
            document.getElementById('telefonoProveedor').value = proveedor.telefono;
            document.getElementById('direccionProveedor').value = proveedor.direccion;
            mostrarModal('proveedor');
        }

        async function eliminarProveedor(id) {
            const resultado = await Swal.fire({
                title: '¿Estás seguro?',
                text: "No podrás revertir esta acción",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, eliminar'
            });
            if (resultado.isConfirmed) {
                const respuesta = await eliminarDatos('proveedores', id);
                if (respuesta) {
                    Swal.fire('Eliminado', 'El proveedor ha sido eliminado', 'success');
                    cargarProveedores();
                }
            }
        }

        // Funciones para manejar clientes
        async function guardarCliente() {
            const cliente = {
                nombreCliente: document.getElementById('nombreCliente').value,
                cedula: document.getElementById('cedulaCliente').value,
                email: document.getElementById('emailCliente').value,
                telefono: document.getElementById('telefonoCliente').value,
                direccion: document.getElementById('direccionCliente').value
            };
            const id = document.getElementById('clienteId').value;
            let resultado;
            if (id) {
                resultado = await actualizarDatos('clientes', id, cliente);
            } else {
                resultado = await enviarDatos('clientes', cliente);
            }
            if (resultado) {
                Swal.fire('Éxito', 'Cliente guardado correctamente', 'success');
                bootstrap.Modal.getInstance(document.getElementById('modalCliente')).hide();
                cargarClientes();
            }
        }

        async function editarCliente(id) {
            const cliente = await obtenerDatos(`clientes/${id}`);
            if (!cliente) return;
            document.getElementById('clienteId').value = cliente._id;
            document.getElementById('nombreCliente').value = cliente.nombreCliente;
            document.getElementById('cedulaCliente').value = cliente.cedula;
            document.getElementById('emailCliente').value = cliente.email;
            document.getElementById('telefonoCliente').value = cliente.telefono;
            document.getElementById('direccionCliente').value = cliente.direccion;
            mostrarModal('cliente');
        }

        async function eliminarCliente(id) {
            const resultado = await Swal.fire({
                title: '¿Estás seguro?',
                text: "No podrás revertir esta acción",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, eliminar'
            });
            if (resultado.isConfirmed) {
                const respuesta = await eliminarDatos('clientes', id);
                if (respuesta) {
                    Swal.fire('Eliminado', 'El cliente ha sido eliminado', 'success');
                    cargarClientes();
                }
            }
        }

        // Inicialización
        document.addEventListener('DOMContentLoaded', () => {
            cargarDatos();
            cargarProveedoresSelect();
        });
    </script>
</body>
</html>